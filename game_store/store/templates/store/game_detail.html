{% extends 'store/base.html' %}

{% block title %}{{ game.title }} - Game Store{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 40px;">
    <div>
        {% if game.image %}
        <img src="{{ game.image.url }}" alt="{{ game.title }}" style="width: 100%; border-radius: 8px;">
        {% else %}
        <div style="width: 100%; height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
            üéÆ
        </div>
        {% endif %}
        
        <!-- –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä—ã -->
        <div style="margin-top: 20px; text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h3 style="margin-bottom: 10px;">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä—ã</h3>
            <div style="font-size: 2rem; color: gold; margin-bottom: 5px;">
                {% if average_rating > 0 %}
                    {% for i in "12345" %}
                        {% if forloop.counter <= average_rating|floatformat:0 %}
                            ‚òÖ
                        {% else %}
                            ‚òÜ
                        {% endif %}
                    {% endfor %}
                {% else %}
                    ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ
                {% endif %}
            </div>
            <p style="margin: 0; color: #666;">
                {{ average_rating|floatformat:1 }}/5 ({{ review_count }} –æ—Ç–∑—ã–≤–æ–≤)
            </p>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <p class="game-price" style="font-size: 2rem;">{{ game.price }} ‚ÇΩ</p>
            
            {% if game.quantity > 0 %}
            <form action="{% url 'add_to_cart' game.id %}" method="post">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                    <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ game.quantity }}" style="width: 60px; padding: 5px;">
                </div>
                
                {% if in_cart %}
                <button type="submit" class="btn" style="background: #28a745;">
                    –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ
                </button>
                <p style="margin-top: 10px; color: #666;">–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ</p>
                {% else %}
                <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
                {% endif %}
            </form>
            {% else %}
            <button class="btn" disabled style="background: #dc3545;">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</button>
            {% endif %}
        </div>
    </div>
    
    <div>
        <h1>{{ game.title }}</h1>
        
        <div style="margin: 20px 0; display: flex; gap: 10px;">
            <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 4px;">
                {{ game.genre.name }}
            </span>
            {% for tag in game.tags.all %}
            <span style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px;">
                {{ tag.name }}
            </span>
            {% endfor %}
        </div>
        
        <div style="margin: 30px 0;">
            <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
            <p style="white-space: pre-line;">{{ game.description }}</p>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h3>
            <table style="width: 100%;">
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;"><strong>–í –Ω–∞–ª–∏—á–∏–∏:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">{{ game.quantity }} —à—Ç.</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;"><strong>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</strong></td>
                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">{{ game.created_at|date:"d.m.Y" }}</td>
                </tr>
                <tr>
                    <td style="padding: 8px;"><strong>ID —Ç–æ–≤–∞—Ä–∞:</strong></td>
                    <td style="padding: 8px;">{{ game.id }}</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<!-- –°–ï–ö–¶–ò–Ø –û–¢–ó–´–í–û–í -->
<div style="margin-top: 50px;">
    <h2>–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π ({{ review_count }})</h2>
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    {% if user.is_authenticated and can_review %}
        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h3>{% if user_review %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ—Ç–∑—ã–≤{% else %}–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% endif %}</h3>
            
            {% if user_review %}
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <p><strong>–í–∞—à —Ç–µ–∫—É—â–∏–π –æ—Ç–∑—ã–≤:</strong> {{ user_review.rating }}/5</p>
                <p>{{ user_review.comment }}</p>
                <p style="font-size: 0.9rem; color: #666;">{{ user_review.created_at|date:"d.m.Y H:i" }}</p>
            </div>
            {% endif %}
            
            <form action="{% url 'add_review' game.id %}" method="post">
                {% csrf_token %}
                
                <div style="margin-bottom: 15px;">
                    <label for="rating"><strong>–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</strong></label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        {% for i in "54321" %}
                        <label style="cursor: pointer;">
                            <input type="radio" name="rating" value="{{ i }}" 
                                   {% if user_review and user_review.rating == i|add:"0" %}checked{% endif %}
                                   required style="display: none;">
                            <span style="font-size: 2rem; color: {% if user_review and user_review.rating >= i|add:"0" %}gold{% else %}#ddd{% endif %};"
                                  onmouseover="this.style.color='gold'"
                                  onmouseout="this.style.color='{% if user_review and user_review.rating >= i|add:"0" %}gold{% else %}#ddd{% endif %}'">
                                ‚òÖ
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="comment"><strong>–í–∞—à –æ—Ç–∑—ã–≤:</strong></label>
                    <textarea name="comment" id="comment" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" 
                              required>{% if user_review %}{{ user_review.comment }}{% endif %}</textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="background: #28a745;">
                        {% if user_review %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% else %}–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% endif %}
                    </button>
                    
                    {% if user_review %}
                    <a href="{% url 'delete_review' user_review.id %}" class="btn btn-danger" 
                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤?')">
                        –£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    {% elif user.is_authenticated and not can_review %}
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #ffc107;">
            <p>‚úã <strong>–í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–π –∏–≥—Ä—ã.</strong></p>
            <p style="margin-top: 5px; font-size: 0.9rem;">–ö—É–ø–∏—Ç–µ –∏–≥—Ä—É, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º.</p>
        </div>
    {% else %}
        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #17a2b8;">
            <p>üîí <strong>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</strong></p>
            <p style="margin-top: 5px; font-size: 0.9rem;">
                <a href="{% url 'site_login' %}?next={% url 'game_detail' game.id %}">–í–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ 
                <a href="/admin/">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º.
            </p>
        </div>
    {% endif %}
    
    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    {% if reviews %}
        <div style="margin-top: 20px;">
            {% for review in reviews %}
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong style="font-size: 1.1rem;">{{ review.user.username }}</strong>
                        {% if review.user.is_staff %}
                        <span style="background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 8px;">
                            üëë –ú–µ–Ω–µ–¥–∂–µ—Ä
                        </span>
                        {% endif %}
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        {{ review.created_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
                
                <div style="color: gold; font-size: 1.2rem; margin-bottom: 10px;">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                            ‚òÖ
                        {% else %}
                            ‚òÜ
                        {% endif %}
                    {% endfor %}
                    <span style="color: #666; font-size: 0.9rem; margin-left: 10px;">{{ review.rating }}/5</span>
                </div>
                
                <p style="margin: 0; line-height: 1.6;">{{ review.comment }}</p>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <p style="font-size: 1.2rem; color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —ç—Ç—É –∏–≥—Ä—É</p>
            <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –æ—Ç–∑—ã–≤!</p>
        </div>
    {% endif %}
</div>

<div style="margin-top: 40px;">
    <a href="{% url 'game_list' %}" class="btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
</div>

<script>
// JavaScript –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –∑–≤–µ–∑–¥–æ—á–µ–∫
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('input[name="rating"] + span');
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.previousElementSibling.value;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –≤—Å–µ—Ö –∑–≤–µ–∑–¥
            stars.forEach(s => {
                s.style.color = '#ddd';
            });
            
            // –ó–∞–∫—Ä–∞—à–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–≤–µ–∑–¥—ã
            for (let i = 0; i < rating; i++) {
                if (stars[i]) {
                    stars[i].style.color = 'gold';
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        star.addEventListener('mouseover', function() {
            const rating = this.previousElementSibling.value;
            
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.style.color = 'gold';
                }
            });
        });
        
        star.addEventListener('mouseout', function() {
            const checked = document.querySelector('input[name="rating"]:checked');
            if (checked) {
                const rating = checked.value;
                stars.forEach((s, index) => {
                    s.style.color = index < rating ? 'gold' : '#ddd';
                });
            } else {
                stars.forEach(s => {
                    s.style.color = '#ddd';
                });
            }
        });
    });
});
</script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞ */
    input[name="rating"] + span {
        transition: color 0.2s;
        cursor: pointer;
    }
    
    input[name="rating"]:checked + span {
        color: gold !important;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .game-detail-container {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .reviews-section {
            padding: 15px;
        }
    }
</style>
{% endblock %}